{{- if .Site.Params.comments -}}
<div class="comments-container">
    <div class="social-discussion">
        <div class="discussion-header">
            <h3>{{ i18n "discussion_title" }}</h3>
            <p>{{ i18n "discussion_desc" }}</p>
        </div>
        <div class="share-links">
            {{- $search_query := .Permalink -}}
            {{- if .Params.shortlink -}}
                {{- $search_query = .Params.shortlink -}}
            {{- end -}}
            {{- $search_query = replace (replace $search_query "https://" "") "http://" "" -}}
            
            {{- $x_url := .Params.x_link | default (printf "https://x.com/search?q=%s" $search_query) -}}
            <a class="share-btn x-btn" href="{{ $x_url }}" target="_blank" rel="noopener noreferrer">
                <i class="fa-brands fa-x-twitter"></i> 
                <span>{{ if .Params.x_link }}{{ i18n "reply_on" (dict "Platform" "X") }}{{ else }}{{ i18n "discuss_on" (dict "Platform" "X") }}{{ end }}</span>
            </a>

            {{- $mastodon_url := .Params.mastodon_link | default (printf "https://mastodon.social/search?q=%s" $search_query) -}}
            <a class="share-btn mastodon-btn" href="{{ $mastodon_url }}" target="_blank" rel="noopener noreferrer">
                <i class="fa-brands fa-mastodon"></i> 
                <span>{{ if .Params.mastodon_link }}{{ i18n "reply_on" (dict "Platform" "Mastodon") }}{{ else }}{{ i18n "discuss_on" (dict "Platform" "Mastodon") }}{{ end }}</span>
            </a>

            {{- $bluesky_url := .Params.bluesky_link | default (printf "https://bsky.app/search?q=%s" $search_query) -}}
            <a class="share-btn bluesky-btn" href="{{ $bluesky_url }}" target="_blank" rel="noopener noreferrer">
                <i class="fa-brands fa-bluesky"></i> 
                <span>{{ if .Params.bluesky_link }}{{ i18n "reply_on" (dict "Platform" "Bluesky") }}{{ else }}{{ i18n "discuss_on" (dict "Platform" "Bluesky") }}{{ end }}</span>
            </a>

            {{- $reddit_url := .Params.reddit_link | default (printf "https://www.reddit.com/search?q=%s" $search_query) -}}
            <a class="share-btn reddit-btn" href="{{ $reddit_url }}" target="_blank" rel="noopener noreferrer">
                <i class="fa-brands fa-reddit"></i> 
                <span>{{ if .Params.reddit_link }}{{ i18n "reply_on" (dict "Platform" "Reddit") }}{{ else }}{{ i18n "discuss_on" (dict "Platform" "Reddit") }}{{ end }}</span>
            </a>

            {{- $hn_url := .Params.hn_link | default (printf "https://news.ycombinator.com/submitlink?u=%s&t=%s" .Permalink .Title) -}}
            <a class="share-btn hn-btn" href="{{ $hn_url }}" target="_blank" rel="noopener noreferrer">
                <i class="fa-brands fa-hacker-news"></i> 
                <span>{{ if .Params.hn_link }}{{ i18n "discuss_on_hn" }}{{ else }}{{ i18n "submit_to_hn" }}{{ end }}</span>
            </a>
        </div>
    </div>

    <div id="webmentions" class="webmentions-container" data-url="{{ .Permalink }}">
        <div class="webmentions-header">
            <div id="webmentions-stats" class="webmentions-stats"></div>
            <div id="webmentions-facepile" class="webmentions-facepile"></div>
        </div>
        <div id="webmentions-list" class="webmentions-list"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('webmentions');
    if (!container) return;

    const targetUrl = container.getAttribute('data-url');
    const statsContainer = document.getElementById('webmentions-stats');
    const facepileContainer = document.getElementById('webmentions-facepile');
    const listContainer = document.getElementById('webmentions-list');

    // i18n strings
    const labels = {
        likes: '{{ i18n "webmentions_likes" }}',
        reposts: '{{ i18n "webmentions_reposts" }}',
        mentions: '{{ i18n "webmentions_mentions" }}',
        none: '{{ i18n "no_webmentions" }}'
    };

    fetch(`https://webmention.io/api/mentions.jf2?target=${targetUrl}`)
        .then(response => response.json())
        .then(data => {
            const mentions = data.children || [];
            if (mentions.length === 0) {
                statsContainer.innerHTML = `<p class="no-mentions">${labels.none}</p>`;
                return;
            }

            const likes = mentions.filter(m => m['wm-property'] === 'like-of');
            const reposts = mentions.filter(m => m['wm-property'] === 'repost-of' || m['wm-property'] === 'bookmark-of');
            const replies = mentions.filter(m => ['in-reply-to', 'mention-of', 'rsvp'].includes(m['wm-property']));

            // Render Stats
            let statsHtml = '';
            if (likes.length) statsHtml += `<span><strong>${likes.length}</strong> ${labels.likes}</span>`;
            if (reposts.length) statsHtml += `<span><strong>${reposts.length}</strong> ${labels.reposts}</span>`;
            if (replies.length) statsHtml += `<span><strong>${replies.length}</strong> ${labels.mentions}</span>`;
            statsContainer.innerHTML = statsHtml;

            // Render Facepile (Likes + Reposts)
            const pile = [...likes, ...reposts];
            const uniquePile = [];
            const seen = new Set();
            pile.forEach(m => {
                if (!seen.has(m.author.url)) {
                    seen.add(m.author.url);
                    uniquePile.push(m);
                }
            });

            if (uniquePile.length) {
                facepileContainer.innerHTML = uniquePile.map(m => `
                    <a href="${m.author.url}" target="_blank" rel="noopener noreferrer" title="${m.author.name}">
                        <img src="${m.author.photo}" alt="${m.author.name}" loading="lazy">
                    </a>
                `).join('');
            }

            // Render Replies
            if (replies.length) {
                listContainer.innerHTML = replies.map(m => `
                    <div class="webmention-item">
                        <div class="webmention-author">
                            <a href="${m.author.url}" target="_blank" rel="noopener noreferrer">
                                <img src="${m.author.photo}" alt="${m.author.name}" loading="lazy">
                                <span>${m.author.name}</span>
                            </a>
                            <time datetime="${m.published}">${new Date(m.published).toLocaleDateString()}</time>
                        </div>
                        <div class="webmention-content">
                            ${m.content ? (m.content.html || m.content.text) : ''}
                        </div>
                    </div>
                `).join('');
            }
        })
        .catch(err => {
            console.error('Error fetching webmentions:', err);
        });
});
</script>
{{- end -}}
