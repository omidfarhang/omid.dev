{{ $images := $.Resources.ByType "image" }}
{{ $featured := $images.GetMatch "*feature*" }}
{{ if not $featured }}{{ $featured = $images.GetMatch "{*cover*,*thumbnail*}" }}{{ end }}

{{ if not $featured }}
    {{/* 1. Select Base Image and Category Label */}}
    {{ $featured = resources.Get "/opengraph/default.jpg" }}
    {{ $categoryName := "Blog" }}
    
    {{ range .Params.categories }}
        {{ if eq (lower .) "techblog"  }}
            {{ $featured = resources.Get "/opengraph/techblog.jpg" }}
            {{ $categoryName = "Tech Blog" }}
        {{ else if eq (lower .) "electronics" }}
            {{ $featured = resources.Get "/opengraph/electronics.jpg" }}
            {{ $categoryName = "Electronics" }}
        {{ else if eq (lower .) "health" }}
            {{ $featured = resources.Get "/opengraph/health.jpg" }}
            {{ $categoryName = "Health" }}
        {{ end }}
    {{ end }}

    {{/* 2. Prepare Font and Colors */}}
    {{ $font := resources.Get "/opengraph/Inter-VariableFont_opsz-wght.ttf" }}
    {{ $accentColor := "#14b8a6" }} {{/* Brighter Teal for OG */}}
    {{ $white := "#FFFFFF" }}

    {{/* 3. Apply Background Filters */}}
    {{/* Darken slightly to make text pop and look more premium */}}
    {{ $featured = $featured | images.Filter (images.Brightness -25) }}

    {{/* 4. Draw Category Label (Small, All-Caps, Accent Color) */}}
    {{ $categoryOptions := dict 
        "color" $accentColor
        "size" 28
        "x" 80 "y" 80
        "font" $font
    }}
    {{ $featured = $featured | images.Filter (images.Text (upper $categoryName) $categoryOptions) }}

    {{/* 5. Prepare Wrapped Title */}}
    {{ $title := $.LinkTitle }}
    {{ $wrappedTitle := "" }}
    {{ $line := "" }}
    {{ $words := split $title " " }}
    {{ range $words }}
        {{/* Wrap at ~22 characters for a balanced look */}}
        {{ if gt (add (len $line) (len .)) 22 }}
            {{ $wrappedTitle = printf "%s%s\n" $wrappedTitle $line }}
            {{ $line = . }}
        {{ else }}
            {{ if eq $line "" }}
                {{ $line = . }}
            {{ else }}
                {{ $line = printf "%s %s" $line . }}
            {{ end }}
        {{ end }}
    {{ end }}
    {{ $wrappedTitle = printf "%s%s" $wrappedTitle $line }}

    {{/* 6. Determine Title Font Size based on length */}}
    {{ $fontSize := 80 }}
    {{ if gt (len $title) 40 }}
        {{ $fontSize = 65 }}
    {{ end }}
    {{ if gt (len $title) 70 }}
        {{ $fontSize = 50 }}
    {{ end }}

    {{/* 7. Draw Title (Large, White) */}}
    {{ $titleOptions := dict 
        "color" $white
        "size" $fontSize
        "lineSpacing" 15
        "x" 80 "y" 140
        "font" $font
    }}
    {{ $featured = $featured | images.Filter (images.Text $wrappedTitle $titleOptions) }}

    {{/* 8. Add Avatar and Site Info (Footer Area) */}}
    {{/* Note: For Hugo to process the avatar, it should be in the assets/ folder */}}
    {{ $avatar := resources.Get "/images/bio-photo-150x150.jpg" }}
    {{ if not $avatar }}
        {{ $avatar = resources.Get "/opengraph/avatar.jpg" }}
    {{ end }}

    {{ if $avatar }}
        {{ $avatar = $avatar.Fill "100x100" }}
        {{ $featured = $featured | images.Filter (images.Overlay $avatar 80 480) }}
    {{ end }}

    {{/* Site Owner Name */}}
    {{ $nameOptions := dict 
        "color" $white
        "size" 36
        "x" 200 "y" 500
        "font" $font
    }}
    {{ $featured = $featured | images.Filter (images.Text "Omid Farhang" $nameOptions) }}

    {{/* Site Domain */}}
    {{ $siteOptions := dict 
        "color" $accentColor
        "size" 24
        "x" 200 "y" 545
        "font" $font
    }}
    {{ $featured = $featured | images.Filter (images.Text "omid.dev" $siteOptions) }}
{{ end }}

{{ return $featured }}

