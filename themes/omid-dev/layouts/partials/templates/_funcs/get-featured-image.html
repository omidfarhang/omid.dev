{{ $images := $.Resources.ByType "image" }}
{{ $featured := $images.GetMatch "*feature*" }}
{{ if not $featured }}{{ $featured = $images.GetMatch "{*cover*,*thumbnail*}" }}{{ end }}

{{ if not $featured }}
    {{/* 1. Determine Category and Base Image Path */}}
    {{ $categoryName := "Blog" }}
    {{ $basePath := "/opengraph/default.jpg" }}
    
    {{ range .Params.categories }}
        {{ if eq (lower .) "techblog"  }}
            {{ $basePath = "/opengraph/techblog.jpg" }}
            {{ $categoryName = "Tech Blog" }}
        {{ else if eq (lower .) "electronics" }}
            {{ $basePath = "/opengraph/electronics.jpg" }}
            {{ $categoryName = "Electronics" }}
        {{ else if eq (lower .) "health" }}
            {{ $basePath = "/opengraph/health.jpg" }}
            {{ $categoryName = "Health" }}
        {{ end }}
    {{ end }}

    {{/* 2. Load Static Resources */}}
    {{ $font := resources.Get "/opengraph/Inter-VariableFont_opsz-wght.ttf" }}
    {{ $avatar := resources.Get "/images/bio-photo-150x150.jpg" }}
    {{ if not $avatar }}
        {{ $avatar = resources.Get "/opengraph/avatar.jpg" }}
    {{ end }}

    {{/* 3. Get Branded Base Image (CACHED per category) */}}
    {{/* This bakes the background, avatar, and static text once per category */}}
    {{ $brandedBase := partialCached "templates/_funcs/get-branded-base.html" (dict "category" $categoryName "basePath" $basePath "font" $font "avatar" $avatar) $categoryName }}

    {{/* 4. Prepare Wrapped Title (Dynamic per post) */}}
    {{ $title := $.LinkTitle }}
    {{ $wrappedTitle := "" }}
    {{ $line := "" }}
    {{ $words := split $title " " }}
    {{ range $words }}
        {{ if gt (add (len $line) (len .)) 22 }}
            {{ $wrappedTitle = printf "%s%s\n" $wrappedTitle $line }}
            {{ $line = . }}
        {{ else }}
            {{ if eq $line "" }}
                {{ $line = . }}
            {{ else }}
                {{ $line = printf "%s %s" $line . }}
            {{ end }}
        {{ end }}
    {{ end }}
    {{ $wrappedTitle = printf "%s%s" $wrappedTitle $line }}

    {{/* 5. Determine Title Font Size */}}
    {{ $fontSize := 80 }}
    {{ if gt (len $title) 40 }}
        {{ $fontSize = 65 }}
    {{ end }}
    {{ if gt (len $title) 70 }}
        {{ $fontSize = 50 }}
    {{ end }}

    {{/* 6. Draw Title on top of the Branded Base */}}
    {{ $titleOptions := dict 
        "color" "#FFFFFF"
        "size" $fontSize
        "lineSpacing" 15
        "x" 80 "y" 140
        "font" $font
    }}
    {{ $featured = $brandedBase | images.Filter (images.Text $wrappedTitle $titleOptions) }}
{{ end }}

{{ return $featured }}

