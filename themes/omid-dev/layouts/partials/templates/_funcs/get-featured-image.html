{{ $images := $.Resources.ByType "image" }}
{{ $featured := $images.GetMatch "*feature*" }}
{{ if not $featured }}{{ $featured = $images.GetMatch "{*cover*,*thumbnail*}" }}{{ end }}

{{ if not $featured }}
    {{/* 1. Determine Category and Base Image Path */}}
    {{ $categoryName := "" }}
    {{ $basePath := "/opengraph/default.jpg" }}
    
    {{ with .Params.categories }}
        {{ $categoryName = index . 0 }}
        {{ range . }}
            {{ if eq (lower .) "techblog" }}
                {{ $basePath = "/opengraph/techblog.jpg" }}
            {{ else if eq (lower .) "electronics" }}
                {{ $basePath = "/opengraph/electronics.jpg" }}
            {{ else if eq (lower .) "health" }}
                {{ $basePath = "/opengraph/health.jpg" }}
            {{ else if eq (lower .) "cozy corner" }}
                {{ $basePath = "/opengraph/cozy-corner.jpg" }}
            {{ end }}
        {{ end }}
    {{ end }}

    {{/* 1.1 Fallback Labels for Sections and Taxonomies */}}
    {{ if eq $categoryName "" }}
        {{ if or (eq .Kind "taxonomy") (eq .Kind "term") }}
            {{ if eq .Type "tags" }}
                {{ $categoryName = cond (eq .Kind "taxonomy") "Tags" "Tag" }}
            {{ else if eq .Type "categories" }}
                {{ $categoryName = cond (eq .Kind "taxonomy") "Categories" "Category" }}
            {{ end }}
        {{ else if eq .Section "posts" }}
            {{ $categoryName = "Blog" }}
        {{ end }}
    {{ end }}

    {{/* 2. Load Static Resources */}}
    {{ $fontPath := "/opengraph/Inter-VariableFont_opsz-wght.ttf" }}
    {{ if eq .Lang "fa" }}
        {{ $fontPath = "/opengraph/Vazirmatn[wght].ttf" }}
    {{ end }}
    {{ $font := resources.Get $fontPath }}
    {{ $avatar := resources.Get "/images/bio-photo-150x150.jpg" }}
    {{ if not $avatar }}
        {{ $avatar = resources.Get "/opengraph/avatar.jpg" }}
    {{ end }}

    {{/* 3. Get Branded Base Image (CACHED per category and language) */}}
    {{/* This bakes the background, avatar, and static text once per category/lang combo */}}
    {{ $cacheKey := printf "%s-%s" $categoryName .Lang }}
    {{ $brandedBase := partialCached "templates/_funcs/get-branded-base.html" (dict "category" $categoryName "basePath" $basePath "font" $font "avatar" $avatar) $cacheKey }}

    {{/* 4. Determine Title Font Size and Max Line Length */}}
    {{ $title := $.LinkTitle }}
    {{ $fontSize := 80 }}
    {{ $maxChars := 22 }}
    
    {{ if gt (len $title) 40 }}
        {{ $fontSize = 65 }}
        {{ $maxChars = 28 }}
    {{ end }}
    {{ if gt (len $title) 70 }}
        {{ $fontSize = 50 }}
        {{ $maxChars = 38 }}
    {{ end }}
    {{ if gt (len $title) 110 }}
        {{ $fontSize = 42 }}
        {{ $maxChars = 45 }}
    {{ end }}

    {{/* 5. Prepare Wrapped Title (Dynamic per post) */}}
    {{ $wrappedTitle := "" }}
    {{ $line := "" }}
    {{ $words := split $title " " }}
    {{ range $words }}
        {{ if gt (add (len $line) (len .)) $maxChars }}
            {{ $wrappedTitle = printf "%s%s\n" $wrappedTitle $line }}
            {{ $line = . }}
        {{ else }}
            {{ if eq $line "" }}
                {{ $line = . }}
            {{ else }}
                {{ $line = printf "%s %s" $line . }}
            {{ end }}
        {{ end }}
    {{ end }}
    {{ $wrappedTitle = printf "%s%s" $wrappedTitle $line }}

    {{/* 6. Draw Title on top of the Branded Base */}}
    {{ $titleOptions := dict 
        "color" "#FFFFFF"
        "size" $fontSize
        "lineSpacing" 15
        "x" 80 "y" 140
        "font" $font
    }}
    {{ $featured = $brandedBase | images.Filter (images.Text $wrappedTitle $titleOptions) }}
{{ end }}

{{ return $featured }}

